name: kreaStream Compiler

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - "**/*.md"
      - "**/*.yml"
      - "**/*.jpg"
      - "**/*.png"
      - "**/*.py"

jobs:
  kreaStreamDerleyici:
    runs-on: ubuntu-latest
    steps:
      - name: "'src' Depo Kontrol√º"
        uses: actions/checkout@v4.2.2
        with:
          path: "src"

      - name: "'build' Depo Kontrol√º"
        uses: actions/checkout@v4.2.2
        with:
          ref: "builds"
          path: "builds"

      - name: Setup JDK
        uses: actions/setup-java@v4.6.0
        with:
          distribution: adopt
          java-version: 17
          cache: gradle

      - name: Verify JDK Installation
        run: |
          java -version
          javac -version
          echo "JAVA_HOME: $JAVA_HOME"

      - name: Cache Android SDK
        id: cache-android-sdk
        uses: actions/cache@v4
        with:
          path: |
            ~/.android
            /usr/local/lib/android
          key: ${{ runner.os }}-android-sdk-v3
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2

      - name: Verify Android SDK Installation
        run: |
          echo "ANDROID_HOME: $ANDROID_HOME"
          if [ -d "$ANDROID_HOME" ]; then
            echo "‚úÖ Android SDK found at: $ANDROID_HOME"
            ls -la "$ANDROID_HOME/" || echo "Android SDK directory listing failed"
          else
            echo "‚ùå Android SDK not found"
          fi

      - name: Cache Android Components
        id: cache-android-components
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_HOME }}/platforms
            ${{ env.ANDROID_HOME }}/platform-tools
            ${{ env.ANDROID_HOME }}/build-tools
            ${{ env.ANDROID_HOME }}/cmdline-tools
          key: ${{ runner.os }}-android-components-v1
          restore-keys: |
            ${{ runner.os }}-android-components-

      - name: Install Required Android Components
        if: steps.cache-android-components.outputs.cache-hit != 'true'
        run: |
          echo "üì• Installing required Android SDK components..."
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2" || echo "‚ö†Ô∏è SDK installation had issues"
          echo "‚úÖ Android components installation completed"

      - name: Gradle Wrapper Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            src/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('src/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Gradle Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/loom-cache
            src/.gradle/caches
            src/.gradle/loom-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('src/*.gradle', 'src/gradle.properties', 'src/build.gradle', 'src/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Find Capital Letter Folders and Check Changes
        id: find_folders
        run: |
          cd $GITHUB_WORKSPACE/src
          
          # Find all directories that start with capital letters
          CAPITAL_FOLDERS=$(find . -maxdepth 1 -type d -name "[A-Z]*" | sed 's|^\./||' | grep -v "^\." | sort)
          echo "üìÅ Capital letter folders found:"
          echo "$CAPITAL_FOLDERS"
          
          # Get changed files in this commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          # If no previous commit (workflow_dispatch), check all folders
          if [ -z "$CHANGED_FILES" ]; then
            echo "üîÑ Workflow dispatch - checking all capital folders"
            FOLDERS_TO_CHECK="$CAPITAL_FOLDERS"
          else
            echo "üìã Changed files:"
            echo "$CHANGED_FILES"
            
            # Find which capital folders have changes
            FOLDERS_TO_CHECK=""
            for folder in $CAPITAL_FOLDERS; do
              if echo "$CHANGED_FILES" | grep -q "^$folder/"; then
                echo "‚úÖ Folder '$folder' has changes"
                FOLDERS_TO_CHECK="$FOLDERS_TO_CHECK $folder"
              fi
            done
            
            # If no specific folder changes detected, check all folders
            if [ -z "$FOLDERS_TO_CHECK" ]; then
              echo "üîç No specific capital folder changes detected, checking all capital folders"
              FOLDERS_TO_CHECK="$CAPITAL_FOLDERS"
            else
              echo "üéØ Only compiling changed folders: $FOLDERS_TO_CHECK"
            fi
          fi
          
          # Check which folders need compilation (cs3 files don't exist in builds branch)
          FOLDERS_TO_COMPILE=""
          for folder in $FOLDERS_TO_CHECK; do
            CS3_FILE="$GITHUB_WORKSPACE/builds/${folder}.cs3"
            if [ ! -f "$CS3_FILE" ]; then
              echo "üì¶ '$folder' needs compilation (.cs3 file missing)"
              FOLDERS_TO_COMPILE="$FOLDERS_TO_COMPILE $folder"
            else
              echo "‚úÖ '$folder' already has .cs3 file"
            fi
          done
          
          # Save results to outputs
          if [ -n "$FOLDERS_TO_COMPILE" ]; then
            echo "folders_to_compile=$FOLDERS_TO_COMPILE" >> $GITHUB_OUTPUT
            echo "COMPILE_NEEDED=true" >> $GITHUB_OUTPUT
          else
            echo "COMPILE_NEEDED=false" >> $GITHUB_OUTPUT
          fi
          
          echo "üìä Summary:"
          echo "Folders to compile: $FOLDERS_TO_COMPILE"

      - name: Check Dependencies Status
        id: cache-check
        run: |
          if [ -f "$HOME/.gradle/caches/modules-2/modules-2.lock" ]; then
            echo "gradle_cache_hit=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Gradle dependencies cache found"
          else
            echo "gradle_cache_hit=false" >> $GITHUB_OUTPUT
            echo "üì• Gradle dependencies will be downloaded"
          fi

      - name: Download Dependencies (if needed)
        if: steps.cache-check.outputs.gradle_cache_hit == 'false' && steps.find_folders.outputs.COMPILE_NEEDED == 'true'
        run: |
          cd $GITHUB_WORKSPACE/src
          chmod +x gradlew
          ./gradlew --version
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      - name: Compile Specific Folders with Lint Handling
        if: steps.find_folders.outputs.COMPILE_NEEDED == 'true'
        run: |
          cd $GITHUB_WORKSPACE/src
          chmod +x gradlew
          
          FOLDERS_TO_COMPILE="${{ steps.find_folders.outputs.folders_to_compile }}"
          echo "üî® Compiling folders: $FOLDERS_TO_COMPILE"
          
          # Use build cache if available
          GRADLE_ARGS=""
          if [ "${{ steps.cache-check.outputs.gradle_cache_hit }}" == "true" ]; then
            echo "üöÄ Using cached dependencies"
            GRADLE_ARGS="--build-cache"
          else
            echo "üì¶ Building with fresh dependencies"
          fi
          
          # Compile each folder individually with lint handling
          for folder in $FOLDERS_TO_COMPILE; do
            echo "üèóÔ∏è  Compiling $folder..."
            
            # Try building with lint checks disabled first
            if ./gradlew :$folder:build $GRADLE_ARGS -x lint; then
              echo "‚úÖ $folder compiled successfully (lint skipped)"
            else
              echo "‚ö†Ô∏è  $folder build failed, trying alternative approaches..."
              
              # Approach 1: Try with lint disabled via command line
              if ./gradlew :$folder:build $GRADLE_ARGS -Pandroid.enableLint=false; then
                echo "‚úÖ $folder compiled successfully (lint disabled via property)"
              else
                # Approach 2: Create a simple lint configuration file
                LINT_CONFIG_FILE="$folder/lint.xml"
                cat > "$LINT_CONFIG_FILE" << 'LINTEOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <lint>
              <issue id="NewApi" severity="ignore" />
              <issue id="GradleDependency" severity="ignore" />
          </lint>
          LINTEOF
                
                # Approach 3: Try with full lint suppression
                if ./gradlew :$folder:assemble $GRADLE_ARGS; then
                  echo "‚úÖ $folder assembled successfully (bypassed lint)"
                else
                  echo "‚ùå $folder failed to compile with all approaches"
                  continue
                fi
              fi
            fi
            
            # Copy the generated .cs3 file
            CS3_SOURCE="$folder/build/*.cs3"
            CS3_DEST="$GITHUB_WORKSPACE/builds/${folder}.cs3"
            
            if ls $CS3_SOURCE 1> /dev/null 2>&1; then
              cp $CS3_SOURCE "$CS3_DEST"
              echo "‚úÖ Copied $folder.cs3 to builds"
            else
              echo "‚ö†Ô∏è  No .cs3 file found for $folder"
              # Try alternative .cs3 locations
              find "$folder/build" -name "*.cs3" -exec cp {} "$GITHUB_WORKSPACE/builds/${folder}.cs3" \; || echo "No .cs3 files found in build directory"
            fi
          done
          
          # Always regenerate plugins.json
          echo "üìÑ Generating plugins.json..."
          if ./gradlew makePluginsJson $GRADLE_ARGS; then
            cp build/plugins.json $GITHUB_WORKSPACE/builds/ || echo "‚ö†Ô∏è plugins.json not found"
          else
            echo "‚ö†Ô∏è Failed to generate plugins.json"
          fi

      - name: Build Output Check
        run: |
          echo "üìÅ Build outputs:"
          ls -la $GITHUB_WORKSPACE/builds/ || echo "Builds directory is empty"

      - name: Derlemeleri Y√ºkle
        run: |
          cd $GITHUB_WORKSPACE/builds
          
          # Check if there are any changes to commit
          if git diff --quiet --exit-code; then
            echo "‚úÖ No changes to commit - build outputs are up to date"
            exit 0
          fi
          
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git commit -m "$GITHUB_SHA - Selective Compilation" \
                     -m "Compiled folders: ${{ steps.find_folders.outputs.folders_to_compile }}"
          git push --force

      - name: Cache Cleanup Info
        if: always()
        run: |
          echo "üìä Cache Statistics:"
          echo "Android SDK Cache: ${{ steps.cache-android-sdk.outputs.cache-hit }}"
          echo "Android Components Cache: ${{ steps.cache-android-components.outputs.cache-hit }}"
          echo "Gradle Cache: ${{ steps.cache-check.outputs.gradle_cache_hit }}"
