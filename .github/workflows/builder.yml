name: kreaStream Compiler

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - "**/*.md"
      - "**/*.yml"
      - "**/*.jpg"
      - "**/*.png"
      - "**/*.py"

jobs:
  kreaStreamDerleyici:
    runs-on: ubuntu-latest
    steps:
      - name: "'src' Depo Kontrol√º"
        uses: actions/checkout@v4.2.2
        with:
          path: "src"

      - name: "'build' Depo Kontrol√º"
        uses: actions/checkout@v4.2.2
        with:
          ref: "builds"
          path: "builds"

      - name: JDK 17 Ayarla
        uses: actions/setup-java@v4.6.0
        with:
          distribution: adopt
          java-version: 17
          cache: gradle

      - name: Android SDK Ayarla
        uses: android-actions/setup-android@v3.2.2

      - name: Gradle Wrapper Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            src/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('src/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-wrapper-

      - name: Gradle Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/loom-cache
            src/.gradle/caches
            src/.gradle/loom-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('src/*.gradle', 'src/gradle.properties', 'src/build.gradle', 'src/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Lint Baselines Cache
        uses: actions/cache@v4
        with:
          path: |
            src/**/lint-baseline.xml
            src/**/lint-baseline.xml.old
          key: ${{ runner.os }}-lint-baselines-${{ hashFiles('src/**/build.gradle', 'src/**/src/main/**/*.kt') }}
          restore-keys: |
            ${{ runner.os }}-lint-baselines-

      - name: Find Capital Letter Folders and Check Changes
        id: find_folders
        run: |
          cd $GITHUB_WORKSPACE/src
          
          # Find all directories that start with capital letters
          CAPITAL_FOLDERS=$(find . -maxdepth 1 -type d -name "[A-Z]*" | sed 's|^\./||' | grep -v "^\." | sort)
          echo "üìÅ Capital letter folders found:"
          echo "$CAPITAL_FOLDERS"
          
          # Get changed files in this commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          # If no previous commit (workflow_dispatch), check all folders
          if [ -z "$CHANGED_FILES" ]; then
            echo "üîÑ Workflow dispatch - checking all capital folders"
            FOLDERS_TO_CHECK="$CAPITAL_FOLDERS"
          else
            echo "üìã Changed files:"
            echo "$CHANGED_FILES"
            
            # Find which capital folders have changes
            FOLDERS_TO_CHECK=""
            for folder in $CAPITAL_FOLDERS; do
              if echo "$CHANGED_FILES" | grep -q "^$folder/"; then
                echo "‚úÖ Folder '$folder' has changes"
                FOLDERS_TO_CHECK="$FOLDERS_TO_CHECK $folder"
              fi
            done
            
            # If no specific folder changes detected, check all folders
            if [ -z "$FOLDERS_TO_CHECK" ]; then
              echo "üîç No specific capital folder changes detected, checking all capital folders"
              FOLDERS_TO_CHECK="$CAPITAL_FOLDERS"
            else
              echo "üéØ Only compiling changed folders: $FOLDERS_TO_CHECK"
            fi
          fi
          
          # Check which folders need compilation (cs3 files don't exist in builds branch)
          FOLDERS_TO_COMPILE=""
          for folder in $FOLDERS_TO_CHECK; do
            CS3_FILE="$GITHUB_WORKSPACE/builds/${folder}.cs3"
            if [ ! -f "$CS3_FILE" ]; then
              echo "üì¶ '$folder' needs compilation (.cs3 file missing)"
              FOLDERS_TO_COMPILE="$FOLDERS_TO_COMPILE $folder"
            else
              echo "‚úÖ '$folder' already has .cs3 file"
            fi
          done
          
          # Save results to outputs
          if [ -n "$FOLDERS_TO_COMPILE" ]; then
            echo "folders_to_compile=$FOLDERS_TO_COMPILE" >> $GITHUB_OUTPUT
            echo "COMPILE_NEEDED=true" >> $GITHUB_OUTPUT
          else
            echo "COMPILE_NEEDED=false" >> $GITHUB_OUTPUT
          fi
          
          echo "üìä Summary:"
          echo "Folders to compile: $FOLDERS_TO_COMPILE"

      - name: Check Dependencies Status
        id: cache-check
        run: |
          if [ -f "$HOME/.gradle/caches/modules-2/modules-2.lock" ]; then
            echo "gradle_cache_hit=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Gradle dependencies cache found"
          else
            echo "gradle_cache_hit=false" >> $GITHUB_OUTPUT
            echo "üì• Gradle dependencies will be downloaded"
          fi

      - name: Download Dependencies (if needed)
        if: steps.cache-check.outputs.gradle_cache_hit == 'false' && steps.find_folders.outputs.COMPILE_NEEDED == 'true'
        run: |
          cd $GITHUB_WORKSPACE/src
          chmod +x gradlew
          ./gradlew --version
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false"

      - name: Create Lint Baselines for Problematic Folders
        if: steps.find_folders.outputs.COMPILE_NEEDED == 'true'
        run: |
          cd $GITHUB_WORKSPACE/src
          chmod +x gradlew
          
          # Check if CanliDizi needs compilation and has lint issues
          if echo "${{ steps.find_folders.outputs.folders_to_compile }}" | grep -q "CanliDizi"; then
            echo "üîß Setting up lint baseline for CanliDizi..."
            
            # Add lint baseline configuration if not present
            if ! grep -q "lint.*baseline" CanliDizi/build.gradle; then
              cat >> CanliDizi/build.gradle << 'EOF'

          android {
              lint {
                  baseline = file("lint-baseline.xml")
                  checkReleaseBuilds = false
                  abortOnError = false
              }
          }
          EOF
              echo "‚úÖ Added lint baseline configuration to CanliDizi"
            fi
            
            # Try to create lint baseline
            echo "üìù Creating lint baseline for CanliDizi..."
            ./gradlew :CanliDizi:updateLintBaseline || echo "‚ö†Ô∏è Lint baseline creation failed, continuing with build..."
          fi

      - name: Fix API Level Issues in Source Code
        if: steps.find_folders.outputs.COMPILE_NEEDED == 'true'
        run: |
          cd $GITHUB_WORKSPACE/src
          
          # Fix Base64 issue in CanliDizi.kt if it exists and needs compilation
          if echo "${{ steps.find_folders.outputs.folders_to_compile }}" | grep -q "CanliDizi"; then
            CANLIDIZI_FILE="CanliDizi/src/main/kotlin/com/kreastream/CanliDizi.kt"
            if [ -f "$CANLIDIZI_FILE" ]; then
              echo "üîß Fixing Base64 API level issue in CanliDizi..."
              
              # Create backup
              cp "$CANLIDIZI_FILE" "${CANLIDIZI_FILE}.backup"
              
              # Replace Base64.getDecoder() with Android Base64
              sed -i 's/Base64.getDecoder().decode(/android.util.Base64.decode(/g' "$CANLIDIZI_FILE"
              sed -i 's/import java.util.Base64/import android.util.Base64/g' "$CANLIDIZI_FILE"
              
              # Add Android Base64 import if not present
              if ! grep -q "import android.util.Base64" "$CANLIDIZI_FILE"; then
                # Find the first import line and add after it
                FIRST_IMPORT_LINE=$(grep -n "^import" "$CANLIDIZI_FILE" | head -1 | cut -d: -f1)
                if [ -n "$FIRST_IMPORT_LINE" ]; then
                  sed -i "${FIRST_IMPORT_LINE}a import android.util.Base64" "$CANLIDIZI_FILE"
                fi
              fi
              
              # Update the decode call to use Android Base64 flags
              sed -i 's/android.util.Base64.decode(/android.util.Base64.decode(/, android.util.Base64.DEFAULT/g' "$CANLIDIZI_FILE"
              
              echo "‚úÖ Fixed Base64 API compatibility issue"
            fi
          fi

      - name: Compile Specific Folders with Lint Handling
        if: steps.find_folders.outputs.COMPILE_NEEDED == 'true'
        run: |
          cd $GITHUB_WORKSPACE/src
          chmod +x gradlew
          
          FOLDERS_TO_COMPILE="${{ steps.find_folders.outputs.folders_to_compile }}"
          echo "üî® Compiling folders: $FOLDERS_TO_COMPILE"
          
          # Use build cache if available
          GRADLE_ARGS=""
          if [ "${{ steps.cache-check.outputs.gradle_cache_hit }}" == "true" ]; then
            echo "üöÄ Using cached dependencies"
            GRADLE_ARGS="--build-cache"
          else
            echo "üì¶ Building with fresh dependencies"
          fi
          
          # Compile each folder individually with lint handling
          for folder in $FOLDERS_TO_COMPILE; do
            echo "üèóÔ∏è  Compiling $folder..."
            
            # Try building with lint checks disabled first
            if ./gradlew :$folder:build $GRADLE_ARGS -x lint; then
              echo "‚úÖ $folder compiled successfully (lint skipped)"
            else
              echo "‚ö†Ô∏è  $folder build failed, trying with lint disabled completely..."
              
              # Disable lint in build.gradle temporarily
              BUILD_GRADLE="$folder/build.gradle"
              if [ -f "$BUILD_GRADLE" ]; then
                cp "$BUILD_GRADLE" "${BUILD_GRADLE}.backup"
                
                # Add lint configuration to disable abort on error
                if ! grep -q "abortOnError" "$BUILD_GRADLE"; then
                  cat >> "$BUILD_GRADLE" << 'EOF'

android {
    lint {
        abortOnError = false
        checkReleaseBuilds = false
    }
}
EOF
                fi
                
                # Try build again with modified configuration
                if ./gradlew :$folder:build $GRADLE_ARGS; then
                  echo "‚úÖ $folder compiled successfully after disabling lint"
                  # Restore original build.gradle
                  mv "${BUILD_GRADLE}.backup" "$BUILD_GRADLE"
                else
                  echo "‚ùå $folder failed to compile even with lint disabled"
                  # Restore original build.gradle
                  mv "${BUILD_GRADLE}.backup" "$BUILD_GRADLE"
                  continue
                fi
              fi
            fi
            
            # Copy the generated .cs3 file
            CS3_SOURCE="$folder/build/*.cs3"
            CS3_DEST="$GITHUB_WORKSPACE/builds/${folder}.cs3"
            
            if ls $CS3_SOURCE 1> /dev/null 2>&1; then
              cp $CS3_SOURCE "$CS3_DEST"
              echo "‚úÖ Copied $folder.cs3 to builds"
            else
              echo "‚ö†Ô∏è  No .cs3 file found for $folder"
            fi
          done
          
          # Always regenerate plugins.json
          echo "üìÑ Generating plugins.json..."
          if ./gradlew makePluginsJson $GRADLE_ARGS; then
            cp build/plugins.json $GITHUB_WORKSPACE/builds/ || echo "‚ö†Ô∏è plugins.json not found"
          else
            echo "‚ö†Ô∏è Failed to generate plugins.json"
          fi

      - name: Build Output Check
        run: |
          echo "üìÅ Build outputs:"
          ls -la $GITHUB_WORKSPACE/builds/ || echo "Builds directory is empty"

      - name: Derlemeleri Y√ºkle
        run: |
          cd $GITHUB_WORKSPACE/builds
          
          # Check if there are any changes to commit
          if git diff --quiet --exit-code; then
            echo "‚úÖ No changes to commit - build outputs are up to date"
            exit 0
          fi
          
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git commit -m "$GITHUB_SHA - Selective Compilation" \
                     -m "Compiled folders: ${{ steps.find_folders.outputs.folders_to_compile }}"
          git push --force
