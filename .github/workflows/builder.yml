name: kreaStream Compiler

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - "**/*.md"
      - "**/*.yml"
      - "**/*.jpg"
      - "**/*.png"
      - "**/*.py"

jobs:
  kreaStreamDerleyici:
    runs-on: ubuntu-latest
    steps:
      - name: "'src' Depo Kontrol√º"
        uses: actions/checkout@v4.2.2
        with:
          path: "src"

      - name: "'build' Depo Kontrol√º"
        uses: actions/checkout@v4.2.2
        with:
          ref: "builds"
          path: "builds"

      - name: Setup JDK
        uses: actions/setup-java@v4.6.0
        with:
          distribution: adopt
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.2.2

      - name: Find Capital Letter Folders and Check Changes
        id: find_folders
        run: |
          cd $GITHUB_WORKSPACE/src
          
          # Find all directories that start with capital letters
          CAPITAL_FOLDERS=$(find . -maxdepth 1 -type d -name "[A-Z]*" | sed 's|^\./||' | grep -v "^\." | sort)
          echo "üìÅ Capital letter folders found:"
          echo "$CAPITAL_FOLDERS"
          
          # Get changed files in this commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          # If no previous commit (workflow_dispatch), check all folders
          if [ -z "$CHANGED_FILES" ]; then
            echo "üîÑ Workflow dispatch - checking all capital folders"
            FOLDERS_TO_CHECK="$CAPITAL_FOLDERS"
          else
            echo "üìã Changed files:"
            echo "$CHANGED_FILES"
            
            # Find which capital folders have changes
            FOLDERS_TO_CHECK=""
            for folder in $CAPITAL_FOLDERS; do
              if echo "$CHANGED_FILES" | grep -q "^$folder/"; then
                echo "‚úÖ Folder '$folder' has changes"
                FOLDERS_TO_CHECK="$FOLDERS_TO_CHECK $folder"
              fi
            done
            
            # If no specific folder changes detected, check all folders
            if [ -z "$FOLDERS_TO_CHECK" ]; then
              echo "üîç No specific capital folder changes detected, checking all capital folders"
              FOLDERS_TO_CHECK="$CAPITAL_FOLDERS"
            else
              echo "üéØ Only compiling changed folders: $FOLDERS_TO_CHECK"
            fi
          fi
          
          # Check which folders need compilation (cs3 files don't exist in builds branch)
          FOLDERS_TO_COMPILE=""
          for folder in $FOLDERS_TO_CHECK; do
            CS3_FILE="$GITHUB_WORKSPACE/builds/${folder}.cs3"
            if [ ! -f "$CS3_FILE" ]; then
              echo "üì¶ '$folder' needs compilation (.cs3 file missing)"
              FOLDERS_TO_COMPILE="$FOLDERS_TO_COMPILE $folder"
            else
              echo "‚úÖ '$folder' already has .cs3 file"
            fi
          done
          
          # Save results to outputs
          if [ -n "$FOLDERS_TO_COMPILE" ]; then
            echo "folders_to_compile=$FOLDERS_TO_COMPILE" >> $GITHUB_OUTPUT
            echo "COMPILE_NEEDED=true" >> $GITHUB_OUTPUT
          else
            echo "COMPILE_NEEDED=false" >> $GITHUB_OUTPUT
          fi
          
          echo "üìä Summary:"
          echo "Folders to compile: $FOLDERS_TO_COMPILE"

      - name: Compile Specific Folders
        if: steps.find_folders.outputs.COMPILE_NEEDED == 'true'
        run: |
          cd $GITHUB_WORKSPACE/src
          chmod +x gradlew
          
          FOLDERS_TO_COMPILE="${{ steps.find_folders.outputs.folders_to_compile }}"
          echo "üî® Compiling folders: $FOLDERS_TO_COMPILE"
          
          # Compile each folder individually
          for folder in $FOLDERS_TO_COMPILE; do
            echo "üèóÔ∏è  Compiling $folder..."
            
            # Try building with lint checks disabled
            if ./gradlew :$folder:build -x lint; then
              echo "‚úÖ $folder compiled successfully"
            else
              echo "‚ö†Ô∏è  $folder build failed, trying with assemble..."
              
              # Try assemble if build fails
              if ./gradlew :$folder:assemble; then
                echo "‚úÖ $folder assembled successfully"
              else
                echo "‚ùå $folder failed to compile"
                continue
              fi
            fi
            
            # Copy the generated .cs3 file
            CS3_SOURCE="$folder/build/*.cs3"
            CS3_DEST="$GITHUB_WORKSPACE/builds/${folder}.cs3"
            
            if ls $CS3_SOURCE 1> /dev/null 2>&1; then
              cp $CS3_SOURCE "$CS3_DEST"
              echo "‚úÖ Copied $folder.cs3 to builds"
            else
              echo "‚ö†Ô∏è  No .cs3 file found for $folder"
              # Try alternative .cs3 locations
              find "$folder/build" -name "*.cs3" -exec cp {} "$GITHUB_WORKSPACE/builds/${folder}.cs3" \; || echo "No .cs3 files found in build directory"
            fi
          done
          
          # Generate plugins.json
          echo "üìÑ Generating plugins.json..."
          if ./gradlew makePluginsJson; then
            cp build/plugins.json $GITHUB_WORKSPACE/builds/ || echo "‚ö†Ô∏è plugins.json not found"
          else
            echo "‚ö†Ô∏è Failed to generate plugins.json"
          fi

      - name: Build Output Check
        run: |
          echo "üìÅ Build outputs:"
          ls -la $GITHUB_WORKSPACE/builds/ || echo "Builds directory is empty"

      - name: Derlemeleri Y√ºkle
        run: |
          cd $GITHUB_WORKSPACE/builds
          
          # Check if there are any changes to commit
          if git diff --quiet --exit-code; then
            echo "‚úÖ No changes to commit - build outputs are up to date"
            exit 0
          fi
          
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git commit -m "$GITHUB_SHA - Selective Compilation" \
                     -m "Compiled folders: ${{ steps.find_folders.outputs.folders_to_compile }}"
          git push --force
